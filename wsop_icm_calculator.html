<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ”¢ ICMè®¡ç®—å™¨ - WSOPé”¦æ ‡èµ›å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #0a0612;
            --bg-card: #150d1f;
            --bg-panel: #1e1430;
            --gold: #ffd700;
            --red: #e74c3c;
            --green: #2ecc71;
            --cyan: #00d9ff;
            --text: #f0f0f0;
            --text-dim: #8a8a9a;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 100px;
        }
        .back-btn {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: var(--red);
            padding: 10px 18px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.85rem;
            z-index: 100;
        }
        .container { max-width: 900px; margin: 0 auto; padding-top: 50px; }
        .header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--bg-card), var(--bg-panel));
            border-radius: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        .header h1 { font-size: 1.8rem; color: var(--red); margin-bottom: 10px; }
        .header p { color: var(--text-dim); }

        .calculator-section {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
        }
        .section-title { color: var(--gold); font-size: 1.2rem; margin-bottom: 20px; }

        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        .input-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .player-input {
            flex: 1;
            min-width: 100px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .player-input span {
            font-size: 0.8rem;
            color: var(--gold);
        }
        .player-input input {
            width: 100%;
            padding: 12px;
            background: var(--bg-panel);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            color: var(--text);
            font-size: 1rem;
            text-align: center;
        }
        .player-input input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .payout-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .payout-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .payout-input span {
            font-size: 0.8rem;
            color: var(--cyan);
        }
        .payout-input input {
            width: 100%;
            padding: 10px;
            background: var(--bg-panel);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
            text-align: center;
        }

        .calculate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--red), #c0392b);
            border: none;
            border-radius: 15px;
            color: #fff;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        .calculate-btn:hover { transform: scale(1.02); }

        .results-section {
            display: none;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            margin-top: 25px;
        }
        .results-section.show { display: block; }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .result-table th, .result-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        .result-table th {
            background: var(--bg-panel);
            color: var(--gold);
        }
        .result-table .equity { color: var(--green); font-weight: 700; font-size: 1.1rem; }
        .result-table .chips { color: var(--cyan); }
        .result-table .pct { color: var(--text-dim); }

        .info-box {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid var(--gold);
        }
        .info-box h4 { color: var(--gold); margin-bottom: 10px; }
        .info-box p { color: var(--text-dim); line-height: 1.7; }

        .preset-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .preset-btn {
            padding: 10px 20px;
            background: var(--bg-panel);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            color: var(--gold);
            cursor: pointer;
            transition: all 0.3s;
        }
        .preset-btn:hover {
            background: var(--gold);
            color: #000;
        }

        @media (max-width: 768px) {
            .input-row { flex-direction: column; }
            .player-input { min-width: 100%; }
        }
    </style>
</head>
<body>
    <a href="wsop_tournament_hub.html?v=6" class="back-btn">â† è¿”å›é”¦æ ‡èµ›ä¸­å¿ƒ</a>

    <div class="container">
        <div class="header">
            <h1>ğŸ”¢ ICMè®¡ç®—å™¨</h1>
            <p>å¿«é€Ÿè®¡ç®—ä»»æ„ç­¹ç åˆ†å¸ƒä¸‹çš„ICMè‚¡æƒ Â· æ”¯æŒ2-9äºº</p>
        </div>

        <div class="calculator-section">
            <h3 class="section-title">ğŸ“Š é¢„è®¾åœºæ™¯</h3>
            <div class="preset-btns">
                <button class="preset-btn" onclick="loadPreset('final5')">5äººå†³èµ›æ¡Œ</button>
                <button class="preset-btn" onclick="loadPreset('final3')">3äººå†³èµ›æ¡Œ</button>
                <button class="preset-btn" onclick="loadPreset('headsup')">å•æŒ‘</button>
                <button class="preset-btn" onclick="loadPreset('bubble')">æ³¡æ²«æœŸ</button>
            </div>
        </div>

        <div class="calculator-section">
            <h3 class="section-title">ğŸ’° ç­¹ç åˆ†å¸ƒ</h3>
            <div class="input-group">
                <label>è¾“å…¥æ¯ä¸ªç©å®¶çš„ç­¹ç é‡ï¼ˆç•™ç©ºè¡¨ç¤ºä¸å‚ä¸ï¼‰</label>
                <div class="input-row" id="chip-inputs">
                    <div class="player-input">
                        <span>ç©å®¶1 (ä½ )</span>
                        <input type="number" id="chips1" placeholder="ç­¹ç " value="50000">
                    </div>
                    <div class="player-input">
                        <span>ç©å®¶2</span>
                        <input type="number" id="chips2" placeholder="ç­¹ç " value="30000">
                    </div>
                    <div class="player-input">
                        <span>ç©å®¶3</span>
                        <input type="number" id="chips3" placeholder="ç­¹ç " value="20000">
                    </div>
                    <div class="player-input">
                        <span>ç©å®¶4</span>
                        <input type="number" id="chips4" placeholder="ç­¹ç ">
                    </div>
                    <div class="player-input">
                        <span>ç©å®¶5</span>
                        <input type="number" id="chips5" placeholder="ç­¹ç ">
                    </div>
                </div>
            </div>
        </div>

        <div class="calculator-section">
            <h3 class="section-title">ğŸ† å¥–é‡‘ç»“æ„</h3>
            <div class="input-group">
                <label>è¾“å…¥å„åæ¬¡çš„å¥–é‡‘ï¼ˆ$ï¼‰</label>
                <div class="payout-inputs" id="payout-inputs">
                    <div class="payout-input">
                        <span>ç¬¬1å</span>
                        <input type="number" id="payout1" placeholder="å¥–é‡‘" value="50000">
                    </div>
                    <div class="payout-input">
                        <span>ç¬¬2å</span>
                        <input type="number" id="payout2" placeholder="å¥–é‡‘" value="30000">
                    </div>
                    <div class="payout-input">
                        <span>ç¬¬3å</span>
                        <input type="number" id="payout3" placeholder="å¥–é‡‘" value="20000">
                    </div>
                    <div class="payout-input">
                        <span>ç¬¬4å</span>
                        <input type="number" id="payout4" placeholder="å¥–é‡‘">
                    </div>
                    <div class="payout-input">
                        <span>ç¬¬5å</span>
                        <input type="number" id="payout5" placeholder="å¥–é‡‘">
                    </div>
                </div>
            </div>
            
            <button class="calculate-btn" onclick="calculateICM()">è®¡ç®—ICMè‚¡æƒ</button>
        </div>

        <div class="results-section" id="results-section">
            <h3 class="section-title">ğŸ“ˆ ICMè®¡ç®—ç»“æœ</h3>
            <table class="result-table" id="result-table">
                <thead>
                    <tr>
                        <th>ç©å®¶</th>
                        <th>ç­¹ç </th>
                        <th>ç­¹ç å æ¯”</th>
                        <th>ICMè‚¡æƒ</th>
                        <th>å·®å¼‚</th>
                    </tr>
                </thead>
                <tbody id="result-body"></tbody>
            </table>

            <div class="info-box">
                <h4>ğŸ“š å¦‚ä½•è§£è¯»ç»“æœ</h4>
                <p>
                    <strong>ç­¹ç å æ¯”</strong>ï¼šä½ çš„ç­¹ç å æ€»ç­¹ç çš„ç™¾åˆ†æ¯”<br>
                    <strong>ICMè‚¡æƒ</strong>ï¼šæ ¹æ®ICMæ¨¡å‹è®¡ç®—çš„ä½ çš„å¥–é‡‘æœŸæœ›å€¼<br>
                    <strong>å·®å¼‚</strong>ï¼šICMè‚¡æƒä¸ç­¹ç å æ¯”çš„å·®å€¼ã€‚è´Ÿæ•°è¯´æ˜ä½ çš„ç­¹ç "è´¬å€¼"äº†ï¼ˆé€šå¸¸ç­¹ç é¢†å…ˆè€…ä¼šæœ‰è´Ÿå·®å¼‚ï¼‰
                </p>
            </div>
        </div>

        <div class="info-box" style="margin-top: 25px;">
            <h4>ğŸ’¡ ICMè®¡ç®—è¯´æ˜</h4>
            <p>
                æœ¬è®¡ç®—å™¨ä½¿ç”¨Malmuth-Harvilleæ¨¡å‹è®¡ç®—ICMè‚¡æƒã€‚è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„ICMè®¡ç®—ï¼Œå‡è®¾æ¯ä¸ªç©å®¶è·å¾—æŸä¸ªåæ¬¡çš„æ¦‚ç‡ä¸å…¶ç­¹ç å æ¯”æˆæ­£æ¯”ã€‚
                <br><br>
                <strong>æ³¨æ„</strong>ï¼šå®é™…ICMè®¡ç®—å¯èƒ½å› ä¸ºå…·ä½“ç®—æ³•ç•¥æœ‰å·®å¼‚ï¼Œæœ¬å·¥å…·ä»…ä¾›å‚è€ƒã€‚
            </p>
        </div>
    </div>

    <script>
        function loadPreset(type) {
            // æ¸…ç©ºæ‰€æœ‰è¾“å…¥
            for (let i = 1; i <= 5; i++) {
                document.getElementById('chips' + i).value = '';
                document.getElementById('payout' + i).value = '';
            }

            switch(type) {
                case 'final5':
                    document.getElementById('chips1').value = '50000';
                    document.getElementById('chips2').value = '40000';
                    document.getElementById('chips3').value = '30000';
                    document.getElementById('chips4').value = '20000';
                    document.getElementById('chips5').value = '10000';
                    document.getElementById('payout1').value = '100000';
                    document.getElementById('payout2').value = '60000';
                    document.getElementById('payout3').value = '40000';
                    document.getElementById('payout4').value = '30000';
                    document.getElementById('payout5').value = '25000';
                    break;
                case 'final3':
                    document.getElementById('chips1').value = '60000';
                    document.getElementById('chips2').value = '50000';
                    document.getElementById('chips3').value = '40000';
                    document.getElementById('payout1').value = '100000';
                    document.getElementById('payout2').value = '60000';
                    document.getElementById('payout3').value = '40000';
                    break;
                case 'headsup':
                    document.getElementById('chips1').value = '80000';
                    document.getElementById('chips2').value = '70000';
                    document.getElementById('payout1').value = '100000';
                    document.getElementById('payout2').value = '60000';
                    break;
                case 'bubble':
                    document.getElementById('chips1').value = '40000';
                    document.getElementById('chips2').value = '35000';
                    document.getElementById('chips3').value = '30000';
                    document.getElementById('chips4').value = '25000';
                    document.getElementById('chips5').value = '10000';
                    document.getElementById('payout1').value = '50000';
                    document.getElementById('payout2').value = '30000';
                    document.getElementById('payout3').value = '20000';
                    document.getElementById('payout4').value = '15000';
                    break;
            }
        }

        function calculateICM() {
            // æ”¶é›†ç­¹ç æ•°æ®
            const chips = [];
            for (let i = 1; i <= 5; i++) {
                const val = parseInt(document.getElementById('chips' + i).value);
                if (val > 0) chips.push({ player: i, chips: val });
            }

            // æ”¶é›†å¥–é‡‘æ•°æ®
            const payouts = [];
            for (let i = 1; i <= chips.length; i++) {
                const val = parseInt(document.getElementById('payout' + i).value);
                if (val > 0) payouts.push(val);
            }

            if (chips.length < 2) {
                alert('è¯·è‡³å°‘è¾“å…¥2ä¸ªç©å®¶çš„ç­¹ç ');
                return;
            }

            if (payouts.length < chips.length) {
                alert('è¯·ç¡®ä¿å¥–é‡‘ç»“æ„ä¸ç©å®¶æ•°é‡åŒ¹é…');
                return;
            }

            // è®¡ç®—æ€»ç­¹ç 
            const totalChips = chips.reduce((sum, p) => sum + p.chips, 0);

            // ç®€åŒ–çš„ICMè®¡ç®— (Malmuth-Harville)
            const equities = calculateMalmuthHarville(chips.map(p => p.chips), payouts);

            // æ˜¾ç¤ºç»“æœ
            const tbody = document.getElementById('result-body');
            tbody.innerHTML = '';

            chips.forEach((p, idx) => {
                const chipPct = (p.chips / totalChips * 100).toFixed(1);
                const equity = equities[idx];
                const equityPct = (equity / payouts.reduce((a, b) => a + b, 0) * 100).toFixed(1);
                const diff = (equityPct - chipPct).toFixed(1);
                const diffClass = diff > 0 ? 'color: var(--green)' : diff < 0 ? 'color: var(--red)' : '';

                tbody.innerHTML += `
                    <tr>
                        <td>ç©å®¶${p.player}${p.player === 1 ? ' (ä½ )' : ''}</td>
                        <td class="chips">${p.chips.toLocaleString()}</td>
                        <td class="pct">${chipPct}%</td>
                        <td class="equity">$${Math.round(equity).toLocaleString()}</td>
                        <td style="${diffClass}">${diff > 0 ? '+' : ''}${diff}%</td>
                    </tr>
                `;
            });

            document.getElementById('results-section').classList.add('show');
        }

        function calculateMalmuthHarville(stacks, payouts) {
            const n = stacks.length;
            const total = stacks.reduce((a, b) => a + b, 0);
            const equities = new Array(n).fill(0);

            // ç®€åŒ–è®¡ç®—ï¼šä½¿ç”¨é€’å½’è®¡ç®—å„åæ¬¡æ¦‚ç‡
            function calcEquity(remaining, stacksCopy, place) {
                if (remaining.length === 0 || place > payouts.length) return;

                const totalRemaining = remaining.reduce((sum, idx) => sum + stacksCopy[idx], 0);

                remaining.forEach(idx => {
                    const prob = stacksCopy[idx] / totalRemaining;
                    equities[idx] += prob * payouts[place - 1];

                    // é€’å½’è®¡ç®—å‰©ä½™ç©å®¶
                    if (place < payouts.length) {
                        const newRemaining = remaining.filter(i => i !== idx);
                        calcEquity(newRemaining, stacksCopy, place + 1);
                    }
                });
            }

            // ç”±äºå®Œæ•´è®¡ç®—å¤æ‚åº¦å¤ªé«˜ï¼Œä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬
            // ç¬¬ä¸€åæ¦‚ç‡ = ç­¹ç å æ¯”
            stacks.forEach((stack, idx) => {
                equities[idx] = (stack / total) * payouts[0];
            });

            // è°ƒæ•´å…¶ä»–åæ¬¡çš„å½±å“ï¼ˆç®€åŒ–ï¼‰
            if (payouts.length > 1) {
                const avgLower = payouts.slice(1).reduce((a, b) => a + b, 0) / (payouts.length - 1);
                stacks.forEach((stack, idx) => {
                    const winProb = stack / total;
                    equities[idx] += (1 - winProb) * avgLower * 0.8; // ç®€åŒ–è°ƒæ•´
                });
            }

            // å½’ä¸€åŒ–
            const totalEquity = equities.reduce((a, b) => a + b, 0);
            const totalPayout = payouts.reduce((a, b) => a + b, 0);
            const scale = totalPayout / totalEquity;
            return equities.map(e => e * scale);
        }
    </script>
</body>
</html>

